---

# @todo Eventually we will move more bits into this role (mostly from the aegir role)

- apt:
    name: [
      nginx,
      libnginx-mod-http-brotli-filter, # coopsymbiotic/ops#265
      ssl-cert # required for the snakeoil cert on the default https vhost
    ]
    state: present
    install_recommends: no
  tags:
    - packages
    - nginx
    - nginx-packages
    - nginx-brotli

- name: Deploy our conf.d overrides such as brotli.conf and logformat.conf
  template:
    src: "etc/nginx/conf.d/{{ item }}"
    dest: "/etc/nginx/conf.d/{{ item }}"
    owner: root
    group: root
    mode: 0644
  with_items:
    - symbiotic-brotli.conf
    - symbiotic-logformat.conf
  notify: reload nginx
  tags:
    - nginx
    - nginx-conf

- name: Make sure the snippets directory exists
  file:
    path: "/etc/nginx/snippets/"
    state: directory
    owner: root
    group: root
    mode: 0755
  tags:
    - nginx
    - nginx-ciphers
    - nginx-conf

- name: Deploy nginx ciphers snippet
  template:
    src: "etc/nginx/snippets/ciphers.conf"
    dest: "/etc/nginx/snippets/ciphers.conf"
    owner: "root"
    group: "root"
    mode: "0444"
  tags:
    - nginx
    - nginx-ciphers
    - nginx-conf

- name: Deploy our top-ips script
  template:
    src: "usr/local/bin/top-ips"
    dest: "/usr/local/bin/top-ips"
    owner: "root"
    group: "root"
    mode: "0755"
  tags:
    - nginx
    - nginx-topips
    - nginx-top-ips
