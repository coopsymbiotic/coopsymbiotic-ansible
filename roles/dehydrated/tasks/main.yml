---

- name: Install the dehydrated Debian package
  ansible.builtin.apt:
    name: "dehydrated"
    state: present
    install_recommends: false
  tags:
    - dehydrated
    - packages

- name: Create dehydrated etc keys directory.
  ansible.builtin.file: path="/etc/dehydrated/keys" state=directory mode=0700 owner=root group=root
  tags:
    - dehydrated

- name: Deploy dehydrated config file.
  ansible.builtin.template: src=etc/dehydrated/config.txt dest=/etc/dehydrated/config.txt owner=root group=root mode=0444
  tags:
    - dehydrated

# NB: run renewals at the end of the day, to reduce the risks of running into rate-limiting
# when creating new certificates.
# @todo Move to a systemd service for better logs?
- name: Configure dehydrated cron
  ansible.builtin.cron:
    name="dehydrated"
    minute="35"
    hour="18"
    job="dehydrated -c >/dev/null"
    cron_file="dehydrated"
    user="root"
    state=present
  tags:
    - dehydrated

- name: Deploy dehydrated hooks.sh script.
  ansible.builtin.template: src=etc/dehydrated/hooks.sh dest=/etc/dehydrated/hooks.sh owner=root group=root mode=0755
  tags:
    - dehydrated

# TODO nginx? deploy a file we can include?

- name: Test this is Apache 2.4 on Debian
  ansible.builtin.stat:
    path: "/etc/apache2/apache2.conf"
  register: apache24debian
  tags:
    - dehydrated

- name: Run Apache tasks
  ansible.builtin.include_tasks:
    file: apache.yml
    apply:
      tags: dehydrated
  when: apache24debian.stat.exists
  tags:
    - dehydrated

- name: Test this is nginx on Debian
  ansible.builtin.stat:
    path: "/etc/nginx/nginx.conf"
  register: nginxdebian
  tags:
    - dehydrated

- name: Run nginx tasks
  ansible.builtin.include_tasks:
    file: nginx.yml
    apply:
      tags: dehydrated
  when: nginxdebian.stat.exists
  tags:
    - dehydrated

- name: Accept the Letsencrypt TOS
  shell: dehydrated --register --accept-terms
  args:
    creates: /etc/dehydrated/accounts/
  tags:
    - dehydrated
    - dehydrated-tos
