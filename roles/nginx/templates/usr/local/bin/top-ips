#!/bin/php
<?php

# Detect and block suspicious activity.
#
# {{ ansible_managed }}

$logFile = $argv[1] ?? '/var/log/nginx/access.log';

if ($logFile == '-') {
  $logFile = 'php://stdin';
}
else {
  if (!file_exists($logFile)) {
    die("Log file does not exist.");
  }
}

// Read all lines from the log file
$lines = file($logFile, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);

// Array to store IP address counts
$ipCounts = [];

// Process each line
foreach ($lines as $line) {
  // Extract the IP address (first field in the log line)
  preg_match('/^(\S+)/', $line, $matches);

  if (isset($matches[1])) {
    $ip = $matches[1];

    // Remove quotes
    $ip = str_replace('"', '', $ip);

    // If IPv4, remove the last part of the IP
    $parts = explode('.', $ip);
    if (count($parts) == 4) {
      $parts[3] = '0';
      $ip = implode('.', $parts);
    }

    // Increment the count for the IP address
    if (isset($ipCounts[$ip])) {
      $ipCounts[$ip]++;
    } else {
      $ipCounts[$ip] = 1;
    }
  }
}

// Sort IP addresses by count in descending order
arsort($ipCounts);

// Output the top IP addresses
$stop = 50;

foreach ($ipCounts as $ip => $count) {
  // Lookup country/org information
  $apiUrl = "http://ipinfo.io/{$ip}/json";
  $response = file_get_contents($apiUrl);
  $info = json_decode($response, true);

  // Lookup the reverse DNS
  $reverse_dns = `host $ip | awk '{ print $5 }'`;
  $reverse_dns = str_replace(["\r", "\n"], '', $reverse_dns);

  // Check if they are blocked
  $output = `iptables -n -L INPUT | grep $ip`;
  $blocked = empty($output) ? '' : '(BLOCKED) ';

  echo "$blocked$ip - $count hits - {$info['org']} ({$info['country']}) {$info['timezone']} {$reverse_dns}\n";

  if ($count > 600) {
    // Block countries with high badbot-rates
    if (!$blocked && in_array($info['country'], ['BR', 'VN', 'UZ', 'IQ', 'CN'])) {
      // Check if it is an IPv4 address
      $parts = explode('.', $ip);
      if (count($parts) == 4) {
        echo "Blocking: $ip/24 (because of country)\n";
        `iptables -I INPUT -s $ip/24 -j DROP`;
      }
    }

    // Check if it's a bot on Google cloud, but not the Google Crawler
    if (!$blocked) {
      if (strpos($reverse_dns, 'googleusercontent.com') !== FALSE) {
        echo "Blocking: $ip/24 (because of rDNS)\n";
        `iptables -I INPUT -s $ip/24 -j DROP`;
      }
    }
  }

  $stop--;
  if (!$stop) {
    break;
  }
}
